---
# Trading Recommendation Service - AI-powered astrological trading recommendations
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recommendation-service
  namespace: time-series-indexing
  labels:
    app: recommendation-service
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: recommendation-service
  template:
    metadata:
      labels:
        app: recommendation-service
        version: v1
    spec:
      containers:
      - name: recommendation-service
        image: python:3.11-slim
        ports:
        - containerPort: 8002
          name: http
          protocol: TCP
        command: ["/bin/bash"]
        args:
          - -c
          - |
            echo "ðŸ”® Starting Trading Recommendation Service..."

            # Install system dependencies
            apt-get update && apt-get install -y \
              libpq-dev \
              gcc \
              curl \
              build-essential \
              wget \
              && rm -rf /var/lib/apt/lists/*

            # Install Python dependencies
            pip install --no-cache-dir \
              fastapi==0.104.1 \
              uvicorn[standard]==0.24.0 \
              pydantic==2.5.0 \
              psycopg2-binary==2.9.9 \
              python-json-logger==2.0.7 \
              pandas \
              numpy \
              requests

            # Install Swiss Ephemeris with proper setup
            echo "ðŸ“¦ Installing Swiss Ephemeris..."
            pip install --no-cache-dir pyswisseph || echo "âš ï¸ Swiss Ephemeris not available, using fallback"

            # Create directory structure
            mkdir -p /app/services
            mkdir -p /app/astro_encoder/core
            mkdir -p /app/astro_encoder/models
            mkdir -p /app/astro_encoder/utils

            # Copy source files from ConfigMap
            cp /source/recommendation_service.py /app/services/

            # Copy astro encoder files with all dependencies
            cp /source/astro_encoder_core_encoder.py /app/astro_encoder/core/encoder.py || echo "âš ï¸ Astro encoder not found"
            cp /source/astro_encoder_models_data_models.py /app/astro_encoder/models/data_models.py || echo "âš ï¸ Data models not found"
            cp /source/astro_encoder_utils_utils.py /app/astro_encoder/utils/utils.py || echo "âš ï¸ Utils not found"

            # Create minimal __init__.py files
            echo "" > /app/services/__init__.py
            echo "" > /app/astro_encoder/__init__.py
            echo "" > /app/astro_encoder/core/__init__.py
            echo "" > /app/astro_encoder/models/__init__.py
            echo "" > /app/astro_encoder/utils/__init__.py

            # Create minimal fallback modules if encoders are missing
            if [ ! -f /app/astro_encoder/core/encoder.py ]; then
              cat > /app/astro_encoder/core/encoder.py << 'EOF'
            class AstroEncoder:
                def __init__(self):
                    pass
                def encode_date(self, date, location='universal'):
                    return None
            EOF
            fi

            # Verify service file exists
            if [ ! -f /app/services/recommendation_service.py ]; then
              echo "âŒ recommendation_service.py not found"
              exit 1
            fi

            echo "âœ… Trading Recommendation Service ready"
            echo "ðŸ”® Starting on port 8002..."

            # Start the service
            cd /app/services
            python recommendation_service.py

        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-host
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-user
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-name
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-password
        - name: DB_PORT
          value: "5432"

        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 90
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Resource limits
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"

        volumeMounts:
        - name: source-code
          mountPath: /source
          readOnly: true

      volumes:
      - name: source-code
        configMap:
          name: recommendation-source-code

      restartPolicy: Always

---
# Service to expose the recommendation service
apiVersion: v1
kind: Service
metadata:
  name: recommendation-service
  namespace: time-series-indexing
  labels:
    app: recommendation-service
spec:
  type: ClusterIP
  ports:
  - port: 8002
    targetPort: 8002
    protocol: TCP
    name: http
  selector:
    app: recommendation-service