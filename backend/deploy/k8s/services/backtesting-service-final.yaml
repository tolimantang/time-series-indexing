---
# Final clean deployment using ConfigMap for source code
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backtesting-service
  namespace: time-series-indexing
  labels:
    app: backtesting-service
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backtesting-service
  template:
    metadata:
      labels:
        app: backtesting-service
        version: v2
    spec:
      containers:
      - name: backtesting-service
        image: python:3.11-slim
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP
        command: ["/bin/bash"]
        args:
          - -c
          - |
            echo "üöÄ Starting Real Backtesting Service..."

            # Install system dependencies
            apt-get update && apt-get install -y \
              libpq-dev \
              gcc \
              curl \
              && rm -rf /var/lib/apt/lists/*

            # Install Python dependencies
            pip install --no-cache-dir \
              fastapi==0.104.1 \
              uvicorn[standard]==0.24.0 \
              pydantic==2.5.0 \
              psycopg2-binary==2.9.9 \
              python-json-logger==2.0.7 \
              pandas \
              numpy

            # Create directory structure
            mkdir -p /app/services
            mkdir -p /app/llm_analyzer

            # Copy source files from ConfigMap
            cp /source/backtesting_service.py /app/services/
            cp /source/enhanced_daily_lunar_tester.py /app/llm_analyzer/

            # Create __init__.py files
            touch /app/services/__init__.py
            touch /app/llm_analyzer/__init__.py

            # Verify files exist
            if [ ! -f /app/services/backtesting_service.py ]; then
              echo "‚ùå backtesting_service.py not found"
              exit 1
            fi

            if [ ! -f /app/llm_analyzer/enhanced_daily_lunar_tester.py ]; then
              echo "‚ùå enhanced_daily_lunar_tester.py not found"
              exit 1
            fi

            echo "‚úÖ Source files copied successfully"
            echo "üåô Starting Real FastAPI backtesting service with EnhancedDailyLunarTester..."

            # Start the service
            cd /app/services
            python backtesting_service.py

        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-host
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-user
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-name
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: market-encoder-secrets
              key: db-password
        - name: DB_PORT
          value: "5432"

        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 90
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Resource limits (increased for real analysis)
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"

        volumeMounts:
        - name: source-code
          mountPath: /source
          readOnly: true

      volumes:
      - name: source-code
        configMap:
          name: backtesting-source-code

      restartPolicy: Always

---
# Service to expose the backtesting service
apiVersion: v1
kind: Service
metadata:
  name: backtesting-service
  namespace: time-series-indexing
  labels:
    app: backtesting-service
spec:
  type: ClusterIP
  ports:
  - port: 8000
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: backtesting-service